{% extends "layout.html" %}
{% block title %}App - SmartCart{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-30 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-2xl font-bold text-red-600">üõçÔ∏è SmartCart</span>
                </div>
                
                <!-- Search Bar -->
                <div class="flex-1 max-w-xl mx-4">
                    <form id="search-form">
                        <label for="search" class="sr-only">Search</label>
                        <div class="relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="ph ph-magnifying-glass text-gray-400"></i>
                            </div>
                            <input type="search" id="search-input" class="relative block w-full appearance-none rounded-md border border-gray-300 dark:border-gray-600 px-3 py-2.5 pl-10 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:z-10 focus:border-red-500 dark:focus:border-red-500 focus:outline-none focus:ring-red-500 sm:text-sm" placeholder="Search for shoes, shirts, etc..." required>
                        </div>
                    </form>
                </div>
                
                <!-- User Info & Actions -->
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('profile') }}" title="My Profile" class="hidden sm:flex items-center text-sm font-medium text-gray-700 dark:text-gray-200 hover:text-red-600 dark:hover:text-red-500">
                        <i class="ph ph-user-circle text-xl mr-1"></i>
                        <span>{{ username }}</span>
                    </a>
                    <a href="{{ url_for('profile') }}#wishlist" title="My Wishlist" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <i class="ph ph-heart text-xl"></i>
                    </a>
                    <button id="theme-toggle" title="Toggle theme" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <!-- Icon injected by JS -->
                    </button>
                    <a href="{{ url_for('logout') }}" title="Logout" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        <i class="ph ph-sign-out text-xl"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Filter Sidebar -->
        <aside id="filter-sidebar" class="w-72 bg-white dark:bg-gray-800 p-6 overflow-y-auto border-r border-gray-200 dark:border-gray-700 transition-all duration-300 ease-in-out hidden flex-shrink-0">
            <h3 class="text-lg font-semibold mb-4">Filters</h3>
            <form id="filter-form">
                <!-- Price Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Price Range</label>
                    <div class="flex space-x-2">
                        <input type="number" id="filter-min-price" placeholder="Min" class="form-input" min="0">
                        <input type="number" id="filter-max-price" placeholder="Max" class="form-input" min="0">
                    </div>
                </div>

                <!-- Category Filter -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                    <div id="filter-category-list" class="filter-list max-h-48 overflow-y-auto space-y-2">
                        <!-- Categories populated by JS -->
                    </div>
                </div>

                <!-- Store Filter -->
                <div class="mb-6">
                    <label class_name="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Store</label>
                    <div id="filter-store-list" class="filter-list max-h-40 overflow-y-auto space-y-2">
                        <!-- Stores populated by JS -->
                    </div>
                </div>

                <!-- Brand Filter -->
                <div class="mb-6">
                    <label class_name="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Brand</label>
                    <div id="filter-brand-list" class="filter-list max-h-48 overflow-y-auto space-y-2">
                        <!-- Brands populated by JS -->
                    </div>
                </div>

                <div class="space-y-3">
                    <button type="submit" class="btn-primary w-full">Apply Filters</button>
                    <button type="reset" id="reset-filters" class="btn-secondary w-full">Reset Filters</button>
                </div>
            </form>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <div class="max-w-full mx-auto">
                <div id="app-message" class="text-center p-12 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                    <i class="ph ph-hand-waving text-5xl text-red-500 mb-4"></i>
                    <h3 class="text-xl font-semibold">Welcome, {{ username }}!</h3>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">Start by searching for a product above to find the best deals.</p>
                </div>

                <div id="recommendations-section" class="hidden">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4">You Might Also Like (AI-Powered)</h2>
                        <div id="ai-recs-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div id="ai-recs-placeholder" class="placeholder-card">
                                <i class="ph ph-brain text-4xl text-gray-400 mb-3"></i>
                                <p>Your AI recommendations will appear here.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold mb-4">Similar Items (Based on Name)</h2>
                        <div id="similar-recs-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div id="similar-recs-placeholder" class="placeholder-card">
                                <i class="ph ph-mouse-click text-4xl text-gray-400 mb-3"></i>
                                <p>Similar items will appear here.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="search-results-section" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="search-results-title" class="text-2xl font-bold">Search Results</h2>
                        <span id="search-results-count" class="text-sm font-medium text-gray-500 dark:text-gray-400"></span>
                    </div>
                    <div id="search-results-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Product cards will be injected here by JavaScript -->
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Custom JavaScript for dynamic behavior -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- State ---
    let allProducts = [];
    let currentSearchQuery = '';
    let currentMinPrice = 0;
    let currentMaxPrice = 100000;
    let pollIntervalId = null; // Store interval ID to clear it

    // --- UI Element References ---
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const appMessage = document.getElementById('app-message');
    const filterSidebar = document.getElementById('filter-sidebar');
    
    const recommendationsSection = document.getElementById('recommendations-section');
    const aiRecsGrid = document.getElementById('ai-recs-grid');
    const aiRecsPlaceholder = document.getElementById('ai-recs-placeholder');
    const similarRecsGrid = document.getElementById('similar-recs-grid');
    const similarRecsPlaceholder = document.getElementById('similar-recs-placeholder');
    
    const searchResultsSection = document.getElementById('search-results-section');
    const searchResultsTitle = document.getElementById('search-results-title');
    const searchResultsCount = document.getElementById('search-results-count');
    const searchResultsGrid = document.getElementById('search-results-grid');
    
    const filterForm = document.getElementById('filter-form');
    const filterMinPrice = document.getElementById('filter-min-price');
    const filterMaxPrice = document.getElementById('filter-max-price');
    const filterCategoryList = document.getElementById('filter-category-list');
    const filterStoreList = document.getElementById('filter-store-list');
    const filterBrandList = document.getElementById('filter-brand-list');
    const resetFiltersBtn = document.getElementById('reset-filters');
    
    const globalLoader = document.getElementById('global-loader');
    const loaderText = globalLoader.querySelector('p:first-of-type'); // Get loader text
    
    const messageBox = document.getElementById('message-box');
    const messageBoxTitle = document.getElementById('message-box-title');
    const messageBoxText = document.getElementById('message-box-text');
    const messageBoxOk = document.getElementById('message-box-ok');
    
    // --- Utility Functions ---
    const showLoader = (isLoading, text = "Searching stores...") => {
        loaderText.textContent = text;
        globalLoader.classList.toggle('hidden', !isLoading);
    };
    const showMessage = (title, text) => {
        messageBoxTitle.textContent = title;
        messageBoxText.textContent = text;
        messageBox.classList.remove('hidden');
    };
    messageBoxOk.addEventListener('click', () => messageBox.classList.add('hidden'));

    // --- Render Functions ---
    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.product = JSON.stringify(product);
        
        card.innerHTML = `
            <div class="relative">
                <span class="product-store">${product.Store}</span>
                <button title="Add to Wishlist" class="wishlist-btn absolute top-2 right-2 p-2 bg-white/70 dark:bg-gray-900/70 rounded-full text-red-500 hover:text-red-700 dark:hover:text-red-400 backdrop-blur-sm transition">
                    <i class="ph ph-heart text-xl"></i>
                </button>
            </div>
            <img src="${product['Image URL']}" alt="${product['Product Name']}" class="product-image" onerror="this.src='https://placehold.co/400x400/e0e0e0/909090?text=Image+Not+Found'">
            <div class="product-info">
                <h3 class="product-name" title="${product['Product Name']}">${product['Product Name']}</h3>
                <p class="product-price">‚Çπ${product.Price.toLocaleString('en-IN')}</p>
            </div>
            <div class="space-y-2 mt-2">
                <a href="${product['Product URL']}" target="_blank" class="btn-secondary">
                    View on Site
                </a>
                <button title="Track Price" class="track-price-btn btn-secondary w-full">
                    <i class="ph ph-tag"></i> Track Price
                </button>
            </div>
        `;
        
        card.querySelector('.wishlist-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            handleWishlistClick(product, e.currentTarget);
        });
        
        card.querySelector('.track-price-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            handleTrackPriceClick(product, e.currentTarget);
        });
        
        card.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A' && !e.target.closest('button')) {
                handleProductClick(product);
            }
        });
        return card;
    }

    // --- MODIFIED: Checks for the new grid loader and removes it ---
    function appendProducts(gridElement, products) {
        if (!products || products.length === 0) return;
        
        // Check if our new grid loader is present and remove it
        const gridLoader = gridElement.querySelector('.grid-loader-container');
        if (gridLoader) {
            gridElement.innerHTML = ''; // Nuke the loader
        }

        products.forEach(product => gridElement.appendChild(createProductCard(product)));
    }

    // --- Renders a full list (e.g., for filters or cache hits) ---
    function renderProducts(gridElement, products, placeholderElement) {
        gridElement.innerHTML = '';
        if (!products || products.length === 0) {
            if (placeholderElement) placeholderElement.classList.remove('hidden');
            if (gridElement === searchResultsGrid) {
                searchResultsCount.textContent = '0 products found';
                gridElement.innerHTML = `<p class="placeholder-card col-span-full">No products matched your filters.</p>`;
            }
        } else {
            if (placeholderElement) placeholderElement.classList.add('hidden');
            products.forEach(product => gridElement.appendChild(createProductCard(product)));
            if (gridElement === searchResultsGrid) {
                searchResultsCount.textContent = `${products.length} products found`;
            }
        }
    }
    
    // --- Filter Functions ---
    function populateFilters(filters) {
        if (!filters) {
            console.warn("No filter data received.");
            return;
        }

        currentMinPrice = filters.minPrice;
        currentMaxPrice = filters.maxPrice;
        filterMinPrice.value = currentMinPrice;
        filterMinPrice.min = currentMinPrice;
        filterMinPrice.max = currentMaxPrice;
        filterMaxPrice.value = currentMaxPrice;
        filterMaxPrice.min = currentMinPrice;
        filterMaxPrice.max = currentMaxPrice;
        
        filterCategoryList.innerHTML = filters.categories.map(cat => `
            <div class="flex items-center">
                <input id="cat-${cat}" type="checkbox" value="${cat}" class="form-checkbox filter-category">
                <label for="cat-${cat}" class="ml-2 text-sm">${cat}</label>
            </div>
        `).join('');
        
        filterStoreList.innerHTML = filters.stores.map(store => `
            <div class="flex items-center">
                <input id="store-${store}" type="checkbox" value="${store}" class="form-checkbox filter-store">
                <label for="store-${store}" class="ml-2 text-sm">${store}</label>
            </div>
        `).join('');
        
        filterBrandList.innerHTML = filters.brands.map(brand => `
            <div class="flex items-center">
                <input id="brand-${brand}" type="checkbox" value="${brand}" class="form-checkbox filter-brand">
                <label for="brand-${brand}" class="ml-2 text-sm truncate" title="${brand}">${brand}</label>
            </div>
        `).join('');

        filterSidebar.classList.remove('hidden');
    }
    
    function applyFilters() {
        // ... (This function is unchanged)
        const minPrice = parseInt(filterMinPrice.value) || currentMinPrice;
        const maxPrice = parseInt(filterMaxPrice.value) || currentMaxPrice;
        
        const selectedCategories = [...document.querySelectorAll('.filter-category:checked')].map(cb => cb.value);
        const selectedStores = [...document.querySelectorAll('.filter-store:checked')].map(cb => cb.value);
        const selectedBrands = [...document.querySelectorAll('.filter-brand:checked')].map(cb => cb.value);
        
        const filteredProducts = allProducts.filter(product => {
            const brand = product['Product Name'].split(' ')[0];
            
            if (product.Price < minPrice || product.Price > maxPrice) return false;
            if (selectedStores.length > 0 && !selectedStores.includes(product.Store)) return false;
            if (selectedBrands.length > 0 && !selectedBrands.includes(brand)) return false;
            if (selectedCategories.length > 0 && !selectedCategories.includes(product.Category)) return false;
            
            return true;
        });
        
        renderProducts(searchResultsGrid, filteredProducts, null);
    }

    // --- Event Handlers ---

    // --- pollForResult (Unchanged from last version) ---
    function pollForResult(taskId, query) {
        if (pollIntervalId) {
            clearInterval(pollIntervalId); // Clear any existing poll
        }

        let pollCount = 0;
        const maxPolls = 30; // Stop after 1.5 minutes (30 * 3s)
        
        pollIntervalId = setInterval(async () => {
            if (pollCount > maxPolls) {
                clearInterval(pollIntervalId);
                showMessage('Search Error', 'The search took too long and timed out.');
                searchResultsCount.textContent = `Search timed out.`;
                return;
            }
            pollCount++;
            
            try {
                const response = await fetch(`/api/search-status/${taskId}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Search failed on the server.');
                }
                
                const data = await response.json();
                
                // --- 1. Handle new products (if any) ---
                if (data.new_products && data.new_products.length > 0) {
                    console.log(`Received ${data.new_products.length} new products.`);
                    appendProducts(searchResultsGrid, data.new_products);
                    allProducts.push(...data.new_products);
                    searchResultsCount.textContent = `${allProducts.length} products found so far...`;
                }
                
                // --- 2. Check for final state ---
                if (data.status === 'SUCCESS') {
                    console.log('Search SUCCESS, all data received.');
                    clearInterval(pollIntervalId);
                    
                    // Set final data
                    allProducts = data.products;
                    // Only re-render if no products were found (to clear "No valid products" error)
                    if (allProducts.length === 0) {
                         renderProducts(searchResultsGrid, [], null);
                    } else {
                        // Otherwise, just update filters and count
                         populateFilters(data.filters);
                         searchResultsCount.textContent = `${allProducts.length} products found.`;
                    }
                    recommendationsSection.classList.remove('hidden');

                } else if (data.status === 'PROCESSING') {
                    console.log('Search PROCESSING... training AI model.');
                    searchResultsCount.textContent = `${allProducts.length} products found... Training AI model.`;

                } else if (data.status === 'PENDING') {
                    console.log('Search PENDING... more scrapers running.');
                    // Keep the last "xx products found so far..." message
                
                } else {
                    clearInterval(pollIntervalId);
                    throw new Error(data.message || 'An unknown error occurred.');
                }
            } catch (error) {
                clearInterval(pollIntervalId);
                showMessage('Search Error', error.message);
                searchResultsCount.textContent = `Search Error: ${error.message}`;
            }
        }, 3000); // Poll every 3 seconds
    }
    
    // --- MODIFIED: Handle Search to add NEW animated loader ---
    searchForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (!query) return;

        currentSearchQuery = query;
        showLoader(true, "Dispatching scrapers..."); // Show loader *briefly*
        appMessage.classList.add('hidden');
        filterSidebar.classList.add('hidden'); // Hide until we have filters
        
        // Clear all old results
        allProducts = [];
        
        // --- NEW: Inject Animated Loader ---
        searchResultsGrid.innerHTML = `
            <div class="grid-loader-container">
                <div class="scanner-animation">
                    <i class="ph ph-shopping-cart-simple text-6xl text-red-500"></i>
                    <div class="scanner-line"></div>
                    <div class="bar bar-1"></div>
                    <div class="bar bar-2"></div>
                    <div class="bar bar-3"></div>
                    <div class="bar bar-4"></div>
                    <div class="bar bar-5"></div>
                </div>
                <p class="text-lg font-medium text-gray-600 dark:text-gray-300 mt-4">
                    Scanning stores for the best deals...
                </p>
            </div>
        `;
        // --- END NEW ---

        searchResultsCount.textContent = 'Searching...';
        searchResultsTitle.textContent = `Results for "${query}"`; // Set title immediately
        searchResultsSection.classList.remove('hidden'); // Show the (empty) results section
        
        recommendationsSection.classList.add('hidden');
        renderProducts(aiRecsGrid, [], aiRecsPlaceholder);
        renderProducts(similarRecsGrid, [], similarRecsPlaceholder);

        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'SUCCESS') {
                // This was a CACHE HIT. Render immediately.
                console.log('Cache hit!');
                showLoader(false);
                
                allProducts = data.products;
                renderProducts(searchResultsGrid, allProducts, null); // This clears loader
                populateFilters(data.filters);
                recommendationsSection.classList.remove('hidden');
                searchResultsCount.textContent = `${allProducts.length} products found.`;
                
            } else if (data.status === 'PENDING') {
                // This was a CACHE MISS. Start polling.
                console.log('Cache miss, starting poll...');
                showLoader(false); 
                searchResultsCount.textContent = "Searching stores... 0 products found.";
                pollForResult(data.task_id, query);
            }

        } catch (error) {
            console.error('Search error:', error);
            showMessage('Search Error', error.message);
            appMessage.classList.remove('hidden');
            searchResultsSection.classList.add('hidden');
            showLoader(false); // Hide loader on error
        }
    });

    // --- (The rest of the file is unchanged) ---

    // Handle Product Click (for recs)
    async function handleProductClick(product) {
        if (!product) return;
        
        // Show small loaders in the recommendation panels
        similarRecsGrid.innerHTML = `<div class="placeholder-card-small"><div class="loader-small"></div><p>Loading...</p></div>`;
        aiRecsGrid.innerHTML = `<div class="placeholder-card-small"><div class="loader-small"></div><p>Warming up AI...</p></div>`;
        
        try {
            const response = await fetch(`/api/recommend?product_name=${encodeURIComponent(product['Product Name'])}`);
            if (!response.ok) throw new Error('Failed to get recommendations');
            
            const data = await response.json();
            renderProducts(similarRecsGrid, data.similar, similarRecsPlaceholder);
            renderProducts(aiRecsGrid, data.ai_powered, aiRecsPlaceholder);
            
            recommendationsSection.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            showMessage('Recommendation Error', error.message);
            renderProducts(similarRecsGrid, [], similarRecsPlaceholder);
            renderProducts(aiRecsGrid, [], aiRecsPlaceholder);
        }
    }
    
    // Handle Wishlist Click
    async function handleWishlistClick(product, button) {
        button.disabled = true;
        try {
            const response = await fetch('/api/wishlist/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(product)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'API error');
            
            if (data.success) {
                button.innerHTML = '<i class="ph ph-check text-xl text-green-500"></i>';
                button.title = 'Added to Wishlist';
            } else {
                button.innerHTML = '<i class="ph ph-x text-xl text-yellow-500"></i>';
                button.title = data.message;
            }
        } catch (error) {
            showMessage('Wishlist Error', error.message);
            button.disabled = false;
        }
    }

    // Handle Track Price Click
    async function handleTrackPriceClick(product, button) {
        button.disabled = true;
        try {
            const response = await fetch('/api/track_price', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(product)
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'API error');
            
            button.textContent = 'Tracking!';
            button.title = 'Price tracking enabled';
        } catch (error) {
            showMessage('Tracking Error', error.message);
            button.disabled = false;
        }
    }
    
    // Handle Filter Form
    filterForm.addEventListener('submit', (e) => {
        e.preventDefault();
        applyFilters();
    });
    
    resetFiltersBtn.addEventListener('click', () => {
        filterForm.reset();
        filterMinPrice.value = currentMinPrice;
        filterMaxPrice.value = currentMaxPrice;
        renderProducts(searchResultsGrid, allProducts, null);
    });

    // --- NEW: Add styles for NEW ANIMATED LOADER ---
    const style = document.createElement('style');
    style.innerHTML = `
        .form-input { @apply relative block w-full appearance-none rounded-md border border-gray-300 dark:border-gray-600 px-3 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:z-10 focus:border-red-500 dark:focus:border-red-500 focus:outline-none focus:ring-red-500 sm:text-sm; }
        .form-checkbox { @apply h-4 w-4 rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-red-600 focus:ring-red-500; }
        .btn-primary { @apply w-full flex justify-center rounded-md border border-transparent bg-red-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:ring-offset-gray-800; }
        .btn-secondary { @apply w-full text-center px-4 py-2 bg-red-50 dark:bg-gray-700 text-red-700 dark:text-red-300 text-sm font-medium rounded-md hover:bg-red-100 dark:hover:bg-gray-600; }
        .product-card { @apply bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 transition-all duration-200 ease-in-out flex flex-col h-full overflow-hidden shadow-sm hover:-translate-y-1 hover:shadow-lg hover:border-red-300 dark:hover:border-red-500; }
        .product-image { @apply w-full h-56 object-contain rounded-md mb-4 bg-gray-50 dark:bg-gray-700; }
        .product-info { @apply flex-grow flex flex-col; }
        .product-name { @apply text-sm font-semibold text-gray-800 dark:text-gray-100 h-10 overflow-hidden mb-2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .product-price { @apply text-lg font-bold text-gray-900 dark:text-white mt-auto mb-3; }
        .product-store { @apply text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-full px-2.5 py-1 self-start mb-2; }
        .placeholder-card { @apply text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-sm col-span-full flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 min-h-[150px]; }
        .placeholder-card-small { @apply text-center p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm col-span-full flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 min-h-[100px]; }
        .loader-small { @apply w-8 h-8 border-2 border-red-500 border-t-transparent rounded-full mb-2 animate-spin-slow; }

        /* --- NEW ANIMATED LOADER --- */
        .grid-loader-container {
            @apply col-span-full flex flex-col items-center justify-center min-h-[300px] p-8 overflow-hidden;
        }
        .scanner-animation {
            @apply relative w-48 h-24 flex items-center justify-center;
        }
        .scanner-animation .bar {
            @apply w-1 h-12 bg-gray-300 dark:bg-gray-600 mx-1 rounded-full;
            animation: scan 1.2s ease-in-out infinite;
        }
        .scanner-animation .bar-1 { animation-delay: 0s; }
        .scanner-animation .bar-2 { animation-delay: 0.1s; }
        .scanner-animation .bar-3 { animation-delay: 0.2s; }
        .scanner-animation .bar-4 { animation-delay: 0.3s; }
        .scanner-animation .bar-5 { animation-delay: 0.4s; }
        
        .scanner-animation .ph {
            @apply absolute left-0 top-1/2 -translate-y-1/2;
            animation: drive-cart 2.4s ease-in-out infinite;
        }
        .scanner-line {
            @apply absolute left-12 h-16 w-0.5 bg-red-500;
            animation: scan-line 2.4s ease-in-out infinite;
        }

        @keyframes scan {
            0%, 100% { transform: scaleY(0.2); }
            50% { transform: scaleY(1.0); background-color: #ef4444; } /* red-500 */
        }
        @keyframes drive-cart {
            0%, 100% { transform: translate(-20px, -50%); }
            40%, 60% { transform: translate(180px, -50%); }
        }
        @keyframes scan-line {
            0%, 100% { transform: translateX(0); opacity: 0; }
            10% { transform: translateX(0); opacity: 1; }
            50% { transform: translateX(110px); opacity: 1; }
            60% { transform: translateX(110px); opacity: 0; }
        }
        /* --- END NEW LOADER --- */
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}